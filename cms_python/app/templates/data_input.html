{% extends "base.html" %}

{% block sidebar %}
<aside class="sidebar">
    <!-- ãƒ‡ãƒ¼ã‚¿å–è¾¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
        <header class="card__header">
            <h3 class="card__title">
                <span class="card__icon">ğŸ“¥</span>
                ãƒ‡ãƒ¼ã‚¿å–è¾¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼
            </h3>
        </header>
        
        <div class="card__content">
            {% include 'components/section_nav.html' %}
        </div>
    </div>

    <!-- å‡¦ç†çŠ¶æ³ã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
        <header class="card__header">
            <h3 class="card__title">
                <span class="card__icon">âš¡</span>
                å‡¦ç†çŠ¶æ³
            </h3>
        </header>
        
        <div class="card__content">
            <div class="process-stats">
                {% for stat in processing_stats %}
                <div class="stat-item">
                    <span class="stat-icon">{{ stat.icon }}</span>
                    <div class="stat-info">
                        <div class="stat-label">{{ stat.label }}</div>
                        <div class="stat-value">{{ stat.value }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="card">
        <header class="card__header">
            <h3 class="card__title">
                <span class="card__icon">ğŸ“‹</span>
                æœ€è¿‘ã®å‡¦ç†å±¥æ­´
            </h3>
        </header>
        
        <div class="card__content">
            <div class="activity-list">
                <div class="activity-item">
                    <span class="activity-icon">âœ…</span>
                    <div class="activity-content">
                        <div class="activity-title">é¢è«‡éŸ³å£°å‡¦ç†å®Œäº†</div>
                        <div class="activity-time">5åˆ†å‰</div>
                    </div>
                </div>
                <div class="activity-item">
                    <span class="activity-icon">ğŸ”„</span>
                    <div class="activity-content">
                        <div class="activity-title">æ±ºç®—è³‡æ–™è§£æä¸­</div>
                        <div class="activity-time">10åˆ†å‰</div>
                    </div>
                </div>
                <div class="activity-item">
                    <span class="activity-icon">ğŸ“§</span>
                    <div class="activity-content">
                        <div class="activity-title">ãƒ¡ãƒ¼ãƒ«è‡ªå‹•åˆ†é¡</div>
                        <div class="activity-time">15åˆ†å‰</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</aside>
{% endblock %}

{% block content %}
<div class="data-input-content">
    <!-- éŸ³å£°ãƒ»å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
    <div class="input-section" id="audio-video-section">
        <div class="section-header">
            <h2>ğŸ¤ éŸ³å£°ãƒ»å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            <p>é¢è«‡è¨˜éŒ²ã€èª¬æ˜ä¼šéŸ³å£°ã€Webä¼šè­°ã®éŒ²ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦è‡ªå‹•å‡¦ç†ã—ã¾ã™</p>
        </div>

        <!-- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ -->
        {% set upload_config = {
            'icon': 'ğŸ“',
            'title': 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—',
            'description': 'ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ<br><small>å¯¾å¿œå½¢å¼: MP3, MP4, WAV, M4A, MOV, AVI (æœ€å¤§500MB)</small>',
            'accept': 'audio/*,video/*',
            'multiple': true,
            'show_file_list': true
        } %}
        
        <div class="upload-area" data-upload-zone>
            <div class="upload-area__content">
                <div class="upload-area__icon">{{ upload_config.icon }}</div>
                <h3 class="upload-area__title">{{ upload_config.title }}</h3>
                <p class="upload-area__description">{{ upload_config.description | safe }}</p>
                <input type="file" 
                       class="upload-area__input" 
                       {% if upload_config.multiple %}multiple{% endif %} 
                       accept="{{ upload_config.accept }}">
                <button class="btn btn--primary upload-area__button">
                    ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
                </button>
            </div>
            
            <div class="upload-area__progress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-bar__fill" style="width: 0%"></div>
                </div>
                <span class="upload-area__status">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
            </div>
        </div>

        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ -->
        <div class="uploaded-files">
            <h3>ğŸ“‹ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</h3>
            <div class="file-list" id="file-list">
                <div class="file-item processing">
                    <div class="file-icon">ğŸ¤</div>
                    <div class="file-info">
                        <div class="file-name">IRé¢è«‡_2024-12-19_BlackRock.mp3</div>
                        <div class="file-details">
                            <span class="file-size">45.2 MB</span>
                            <span class="file-duration">1:23:45</span>
                            <span class="file-status processing">éŸ³å£°èªè­˜ä¸­... 67%</span>
                        </div>
                        <div class="processing-progress">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 67%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn--secondary" onclick="pauseProcessing('blackrock-audio')">
                            â¸ï¸ ä¸€æ™‚åœæ­¢
                        </button>
                    </div>
                </div>

                <div class="file-item completed">
                    <div class="file-icon">ğŸ¥</div>
                    <div class="file-info">
                        <div class="file-name">æ±ºç®—èª¬æ˜ä¼š_Q3_2024.mp4</div>
                        <div class="file-details">
                            <span class="file-size">189.5 MB</span>
                            <span class="file-duration">0:45:30</span>
                            <span class="file-status completed">å‡¦ç†å®Œäº†</span>
                        </div>
                        <div class="processing-results">
                            <span class="result-item">ğŸ“ æ–‡å­—èµ·ã“ã—å®Œäº†</span>
                            <span class="result-item">ğŸ·ï¸ 15å€‹ã®ãƒˆãƒ”ãƒƒã‚¯æŠ½å‡º</span>
                            <span class="result-item">â“ 23å€‹ã®è³ªå•æ¤œå‡º</span>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn--primary" onclick="viewResults('q3-video')">
                            ğŸ“Š çµæœã‚’è¡¨ç¤º
                        </button>
                        <button class="btn btn--secondary" onclick="downloadTranscript('q3-video')">
                            ğŸ“„ æ–‡å­—èµ·ã“ã—
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Webä¼šè­°é€£æº -->
    <div class="input-section" id="web-meeting-section" style="display: none;">
        <div class="section-header">
            <h2>ğŸ’» Webä¼šè­°é€£æº</h2>
            <p>Zoomã€Teamsã€Webexãªã©ã®Webä¼šè­°ã‚·ã‚¹ãƒ†ãƒ ã¨é€£æºã—ã¦è‡ªå‹•éŒ²ç”»ãƒ»å‡¦ç†ã‚’è¡Œã„ã¾ã™</p>
        </div>

        <div class="meeting-integration">
            <div class="integration-card">
                <div class="integration-icon">ğŸ”—</div>
                <div class="integration-info">
                    <h3>Zoomé€£æº</h3>
                    <p>è‡ªå‹•éŒ²ç”»ãƒ»æ–‡å­—èµ·ã“ã—ãƒ»è³ªå•æŠ½å‡º</p>
                    <button class="btn btn--primary">é€£æºè¨­å®š</button>
                </div>
            </div>
            <div class="integration-card">
                <div class="integration-icon">ğŸ”—</div>
                <div class="integration-info">
                    <h3>Teamsé€£æº</h3>
                    <p>ä¼šè­°éŒ²ç”»ãƒ»è‡ªå‹•å‡¦ç†ãƒ»åˆ†æ</p>
                    <button class="btn btn--primary">é€£æºè¨­å®š</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¡ãƒ¼ãƒ«ç®¡ç† -->
    <div class="input-section" id="email-section" style="display: none;">
        <div class="section-header">
            <h2>ğŸ“§ ãƒ¡ãƒ¼ãƒ«ç®¡ç†</h2>
            <p>æŠ•è³‡å®¶ã‹ã‚‰ã®ãƒ¡ãƒ¼ãƒ«ã‚’è‡ªå‹•åˆ†é¡ãƒ»åˆ†æãƒ»FAQç”Ÿæˆã—ã¾ã™</p>
        </div>

        <div class="email-management">
            <div class="email-stats">
                <div class="stat-card">
                    <div class="stat-number">127</div>
                    <div class="stat-label">ä»Šæœˆã®å—ä¿¡ãƒ¡ãƒ¼ãƒ«</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">23</div>
                    <div class="stat-label">è‡ªå‹•åˆ†é¡æ¸ˆã¿</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">8</div>
                    <div class="stat-label">FAQå€™è£œ</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ±ºç®—è³‡æ–™ -->
    <div class="input-section" id="documents-section" style="display: none;">
        <div class="section-header">
            <h2>ğŸ“„ æ±ºç®—è³‡æ–™</h2>
            <p>æ±ºç®—è³‡æ–™ã€é©æ™‚é–‹ç¤ºè³‡æ–™ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦è‡ªå‹•åˆ†æãƒ»FAQç”Ÿæˆã‚’è¡Œã„ã¾ã™</p>
        </div>

        <div class="document-upload">
            <div class="upload-area">
                <div class="upload-placeholder">
                    <div class="upload-icon">ğŸ“„</div>
                    <div class="upload-text">
                        <h3>æ±ºç®—è³‡æ–™ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                        <p>PDFã€Wordã€Excelãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œ</p>
                        <small>å¯¾å¿œå½¢å¼: PDF, DOCX, XLSX (æœ€å¤§100MB)</small>
                    </div>
                    <input type="file" id="documentInput" multiple accept=".pdf,.docx,.xlsx" style="display: none;">
                    <button class="btn btn--primary" onclick="document.getElementById('documentInput').click()">
                        è³‡æ–™é¸æŠ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
document.querySelectorAll('.section-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const sectionId = this.dataset.section;
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
        document.querySelectorAll('.section-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.input-section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(sectionId + '-section').style.display = 'block';
    });
});

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
document.getElementById('audioVideoInput').addEventListener('change', async function(e) {
    const files = e.target.files;
    if (files.length > 0) {
        try {
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }
            
            const response = await fetch('/api/data-input/upload', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            
            if (result.success) {
                KAGAMI.notify.toast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
                updateFileList();
            }
        } catch (error) {
            KAGAMI.notify.toast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
    }
});

// ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
const uploadArea = document.getElementById('audioVideoUploadArea');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFileUpload(files);
    }
});

async function handleFileUpload(files) {
    try {
        const formData = new FormData();
        for (let file of files) {
            formData.append('files', file);
        }
        
        const response = await fetch('/api/data-input/upload', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        
        if (result.success) {
            KAGAMI.notify.toast('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
            updateFileList();
        }
    } catch (error) {
        KAGAMI.notify.toast('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

async function updateFileList() {
    try {
        const response = await fetch('/api/data-input/files');
        const files = await response.json();
        
        const fileList = document.getElementById('audioVideoFilesList');
        fileList.innerHTML = '';
        
        files.forEach(file => {
            const fileItem = createFileItem(file);
            fileList.appendChild(fileItem);
        });
    } catch (error) {
        console.error('ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    }
}

function createFileItem(file) {
    const div = document.createElement('div');
    div.className = `file-item ${file.status}`;
    div.innerHTML = `
        <div class="file-icon">${file.type === 'audio' ? 'ğŸ¤' : 'ğŸ¥'}</div>
        <div class="file-info">
            <div class="file-name">${file.name}</div>
            <div class="file-details">
                <span class="file-size">${file.size}</span>
                <span class="file-duration">${file.duration}</span>
                <span class="file-status ${file.status}">${file.statusText}</span>
            </div>
            ${file.status === 'processing' ? `
                <div class="processing-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${file.progress}%"></div>
                    </div>
                </div>
            ` : ''}
        </div>
        <div class="file-actions">
            ${file.status === 'processing' ? 
                `<button class="btn btn--secondary" onclick="pauseProcessing('${file.id}')">â¸ï¸ ä¸€æ™‚åœæ­¢</button>` :
                `<button class="btn btn--primary" onclick="viewResults('${file.id}')">ğŸ“Š çµæœã‚’è¡¨ç¤º</button>`
            }
        </div>
    `;
    return div;
}

async function pauseProcessing(fileId) {
    try {
        const response = await fetch(`/api/data-input/pause/${fileId}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            KAGAMI.notify.toast('å‡¦ç†ã‚’ä¸€æ™‚åœæ­¢ã—ã¾ã—ãŸ', 'info');
            updateFileList();
        }
    } catch (error) {
        KAGAMI.notify.toast('ä¸€æ™‚åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

async function viewResults(fileId) {
    try {
        const response = await fetch(`/api/data-input/results/${fileId}`);
        const results = await response.json();
        
        // çµæœè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        showResultsModal(results);
    } catch (error) {
        KAGAMI.notify.toast('çµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

function showResultsModal(results) {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
    console.log('å‡¦ç†çµæœ:', results);
}

async function downloadTranscript(fileId) {
    try {
        const response = await fetch(`/api/data-input/transcript/${fileId}`);
        const blob = await response.blob();
        
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `transcript_${fileId}.txt`;
        a.click();
        
        window.URL.revokeObjectURL(url);
    } catch (error) {
        KAGAMI.notify.toast('æ–‡å­—èµ·ã“ã—ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
setInterval(updateFileList, 10000); // 10ç§’é–“éš”
</script>
{% endblock %} 