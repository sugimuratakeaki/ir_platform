{% extends "base.html" %}
{% from 'components/sidebar_card.html' import card with context %}

{% block title %}å¯¾è©±ç®¡ç†{% endblock %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" href="{{ url_for('static', path='css/dialogue.css') }}" type="text/css">
{% endblock %}

{% block sidebar %}
<aside class="layout-sidebar">
    {% call card('å¯¾è©±ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼', icon='ğŸ”') %}
    <div class="filter-controls">
        <button class="filter-btn active" data-filter="all">ã™ã¹ã¦</button>
        <button class="filter-btn" data-filter="unassigned">æœªæ‹…å½“</button>
        <button class="filter-btn" data-filter="my-tasks">è‡ªåˆ†ã®ã‚¿ã‚¹ã‚¯</button>
        <button class="filter-btn" data-filter="urgent">è¦ç·Šæ€¥å¯¾å¿œ</button>
    </div>
    {% endcall %}

    {% call card('ã‚½ãƒ¼ãƒˆé †', icon='â†•ï¸') %}
    <select id="sortSelect" class="form-control">
        <option value="time">å—ä¿¡æ™‚é–“</option>
        <option value="priority">å„ªå…ˆåº¦</option>
        <option value="investor">æŠ•è³‡å®¶ç¨®åˆ¥</option>
    </select>
    {% endcall %}
</aside>
{% endblock %}

{% block content %}
<main class="layout-content">
    <div class="page-header">
        <h1 class="page-title">ğŸ’¬ å¯¾è©±ç®¡ç†</h1>
        <div class="header-actions">
            <button class="btn-secondary">æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</button>
        </div>
    </div>

    <div class="section-tabs">
        <button class="section-btn active" data-section="inbox">å—ä¿¡ãƒˆãƒ¬ã‚¤ (3)</button>
        <button class="section-btn" data-section="active">é€²è¡Œä¸­ (5)</button>
        <button class="section-btn" data-section="closed">å®Œäº† (128)</button>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div id="inbox-section" class="dialogue-section">
        {% include 'components/dialogue_inbox.html' %}
    </div>

    <div id="active-section" class="dialogue-section" style="display: none;">
        <p>é€²è¡Œä¸­ã®å¯¾è©±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    </div>

    <div id="closed-section" class="dialogue-section" style="display: none;">
        <p>å®Œäº†ã—ãŸå¯¾è©±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script>
// ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
document.querySelectorAll('.section-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const sectionId = this.dataset.section;
        
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
        document.querySelectorAll('.section-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.dialogue-section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(sectionId + '-section').style.display = 'block';
    });
});

// ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const filter = this.dataset.filter;
        filterInboxItems(filter);
    });
});

function filterInboxItems(filter) {
    const items = document.querySelectorAll('.inbox-item');
    items.forEach(item => {
        if (filter === 'all' || item.classList.contains(filter)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// å¯¾è©±æ©Ÿèƒ½
async function openDialogue(queryId) {
    try {
        const response = await fetch(`/api/dialogue/open/${queryId}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            // å¯¾è©±ç”»é¢ã‚’é–‹ã
            showDialogueModal(queryId);
        }
    } catch (error) {
        KAGAMI.notify.toast('å¯¾è©±ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

function showDialogueModal(queryId) {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
    KAGAMI.notify.toast('å¯¾è©±ç”»é¢ã‚’é–‹ãã¾ã—ãŸ', 'info');
}

async function assignTo(queryId) {
    try {
        const response = await fetch(`/api/dialogue/assign/${queryId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ assignee: 'current_user' })
        });
        const result = await response.json();
        
        if (result.success) {
            KAGAMI.notify.toast('æ‹…å½“è€…ã‚’å‰²ã‚Šå½“ã¦ã¾ã—ãŸ', 'success');
        }
    } catch (error) {
        KAGAMI.notify.toast('æ‹…å½“è€…å‰²ã‚Šå½“ã¦ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

async function createFAQ(queryId) {
    try {
        const response = await fetch(`/api/dialogue/create-faq/${queryId}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            KAGAMI.notify.toast('FAQä½œæˆã‚’é–‹å§‹ã—ã¾ã—ãŸ', 'success');
            // FAQç®¡ç†ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            window.location.href = '/ai-faq';
        }
    } catch (error) {
        KAGAMI.notify.toast('FAQä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

async function sendResponse(queryId) {
    try {
        const response = await fetch(`/api/dialogue/send/${queryId}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            KAGAMI.notify.toast('å›ç­”ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
            updateActiveList();
        }
    } catch (error) {
        KAGAMI.notify.toast('å›ç­”é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

async function editResponse(queryId) {
    KAGAMI.notify.toast('ç·¨é›†æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'info');
}

async function requestApproval(queryId) {
    try {
        const response = await fetch(`/api/dialogue/approval/${queryId}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            KAGAMI.notify.toast('æ‰¿èªä¾é ¼ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success');
        }
    } catch (error) {
        KAGAMI.notify.toast('æ‰¿èªä¾é ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

async function viewDetails(queryId) {
    try {
        const response = await fetch(`/api/dialogue/details/${queryId}`);
        const details = await response.json();
        
        // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        showDetailsModal(details);
    } catch (error) {
        KAGAMI.notify.toast('è©³ç´°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
    }
}

function showDetailsModal(details) {
    // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯
    console.log('è©³ç´°:', details);
}

async function updateActiveList() {
    try {
        const response = await fetch('/api/dialogue/active');
        const activeItems = await response.json();
        
        // é€²è¡Œä¸­ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        console.log('é€²è¡Œä¸­æ›´æ–°:', activeItems);
    } catch (error) {
        console.error('é€²è¡Œä¸­ãƒªã‚¹ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
document.getElementById('sortSelect').addEventListener('change', function() {
    const sortBy = this.value;
    sortInboxItems(sortBy);
});

function sortInboxItems(sortBy) {
    const items = Array.from(document.querySelectorAll('.inbox-item'));
    
    items.sort((a, b) => {
        switch(sortBy) {
            case 'time':
                return new Date(b.querySelector('.received-time').textContent) - 
                       new Date(a.querySelector('.received-time').textContent);
            case 'priority':
                const priorityOrder = { 'urgent': 3, 'high': 2, 'normal': 1 };
                const aPriority = a.querySelector('.priority').classList.contains('urgent') ? 'urgent' : 'normal';
                const bPriority = b.querySelector('.priority').classList.contains('urgent') ? 'urgent' : 'normal';
                return priorityOrder[bPriority] - priorityOrder[aPriority];
            case 'investor':
                const aType = a.querySelector('.investor-type').textContent;
                const bType = b.querySelector('.investor-type').textContent;
                return aType.localeCompare(bType);
            default:
                return 0;
        }
    });
    
    const container = document.querySelector('.inbox-list');
    items.forEach(item => container.appendChild(item));
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
setInterval(updateActiveList, 30000); // 30ç§’é–“éš”
</script>
{% endblock %} 