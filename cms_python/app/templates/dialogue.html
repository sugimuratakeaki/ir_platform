{% extends "base.html" %}

{% block sidebar %}
<aside class="sidebar">
    <div class="card">
        <header class="card__header">
            <h3 class="card__title">
                <span class="card__icon">💬</span>
                対話管理
            </h3>
        </header>
        
        <div class="card__content">
            <nav class="section-nav">
                <button class="section-btn active" data-section="inbox">
                    📥 受信トレイ
                </button>
                <button class="section-btn" data-section="active">
                    🔄 進行中
                </button>
                <button class="section-btn" data-section="resolved">
                    ✅ 解決済み
                </button>
                <button class="section-btn" data-section="analytics">
                    📊 分析
                </button>
            </nav>
        </div>
    </div>

    <div class="card">
        <header class="card__header">
            <h3 class="card__title">
                <span class="card__icon">📊</span>
                今日の統計
            </h3>
        </header>
        
        <div class="card__content">
            <div class="dialogue-stats">
                <div class="stat-item">
                    <span class="stat-icon">📥</span>
                    <div class="stat-info">
                        <div class="stat-label">新規問い合わせ</div>
                        <div class="stat-value">12</div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">⏱️</span>
                    <div class="stat-info">
                        <div class="stat-label">平均応答時間</div>
                        <div class="stat-value">2.3h</div>
                    </div>
                </div>
                <div class="stat-item">
                    <span class="stat-icon">🎯</span>
                    <div class="stat-info">
                        <div class="stat-label">満足度</div>
                        <div class="stat-value">96.8%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <header class="card__header">
            <h3 class="card__title">
                <span class="card__icon">🚨</span>
                緊急対応
            </h3>
        </header>
        
        <div class="card__content">
            <div class="urgent-list">
                <div class="urgent-item">
                    <span class="urgent-icon">🚨</span>
                    <div class="urgent-content">
                        <div class="urgent-title">大型機関投資家からの重要質問</div>
                        <div class="urgent-time">5分前</div>
                    </div>
                </div>
                <div class="urgent-item">
                    <span class="urgent-icon">⚠️</span>
                    <div class="urgent-content">
                        <div class="urgent-title">決算発表後の緊急対応</div>
                        <div class="urgent-time">15分前</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</aside>
{% endblock %}

{% block content %}
<div class="dialogue-content">
    <!-- 受信トレイ -->
    <div class="dialogue-section" id="inbox-section">
        <div class="section-header">
            <h2>📥 受信トレイ</h2>
            <p>投資家からの問い合わせを管理・対応</p>
        </div>

        <div class="inbox-controls">
            <div class="filter-controls">
                <button class="filter-btn active" data-filter="all">すべて</button>
                <button class="filter-btn" data-filter="urgent">緊急</button>
                <button class="filter-btn" data-filter="institutional">機関投資家</button>
                <button class="filter-btn" data-filter="individual">個人投資家</button>
            </div>
            <div class="sort-controls">
                <select id="sortSelect">
                    <option value="time">受信時間順</option>
                    <option value="priority">優先度順</option>
                    <option value="investor">投資家タイプ順</option>
                </select>
            </div>
        </div>

        <div class="inbox-list">
            <div class="inbox-item urgent">
                <div class="item-header">
                    <div class="investor-info">
                        <span class="investor-type institutional">機関投資家</span>
                        <span class="investor-name">BlackRock Japan</span>
                    </div>
                    <div class="item-meta">
                        <span class="priority urgent">緊急</span>
                        <span class="received-time">5分前</span>
                    </div>
                </div>
                <div class="item-content">
                    <h4>来期の半導体事業の成長戦略について</h4>
                    <p>当社の投資判断において、半導体事業の成長戦略について詳細な情報が必要です。特に...</p>
                </div>
                <div class="item-actions">
                    <button class="btn btn--primary" onclick="openDialogue('blackrock-query')">対応開始</button>
                    <button class="btn btn--secondary" onclick="assignTo('blackrock-query')">担当者割り当て</button>
                    <button class="btn btn--secondary" onclick="createFAQ('blackrock-query')">FAQ作成</button>
                </div>
            </div>

            <div class="inbox-item">
                <div class="item-header">
                    <div class="investor-info">
                        <span class="investor-type individual">個人投資家</span>
                        <span class="investor-name">田中 太郎</span>
                    </div>
                    <div class="item-meta">
                        <span class="priority normal">通常</span>
                        <span class="received-time">1時間前</span>
                    </div>
                </div>
                <div class="item-content">
                    <h4>ESG戦略について</h4>
                    <p>当社のESG戦略について詳しく教えてください。特に環境への取り組みについて...</p>
                </div>
                <div class="item-actions">
                    <button class="btn btn--primary" onclick="openDialogue('tanaka-query')">対応開始</button>
                    <button class="btn btn--secondary" onclick="assignTo('tanaka-query')">担当者割り当て</button>
                    <button class="btn btn--secondary" onclick="createFAQ('tanaka-query')">FAQ作成</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 進行中 -->
    <div class="dialogue-section" id="active-section" style="display: none;">
        <div class="section-header">
            <h2>🔄 進行中</h2>
            <p>対応中の問い合わせを管理</p>
        </div>

        <div class="active-list">
            <div class="active-item">
                <div class="item-header">
                    <div class="investor-info">
                        <span class="investor-type institutional">機関投資家</span>
                        <span class="investor-name">Nomura Asset Management</span>
                    </div>
                    <div class="item-meta">
                        <span class="status in-progress">対応中</span>
                        <span class="assigned-to">担当: 田中 IR担当者</span>
                    </div>
                </div>
                <div class="item-content">
                    <h4>決算発表後の業績見通しについて</h4>
                    <p>先日の決算発表を受けて、今後の業績見通しについて詳細な説明を求めます...</p>
                </div>
                <div class="response-preview">
                    <h5>📝 回答案</h5>
                    <p>当社の業績見通しについて、以下の通りご説明いたします...</p>
                </div>
                <div class="item-actions">
                    <button class="btn btn--success" onclick="sendResponse('nomura-query')">回答送信</button>
                    <button class="btn btn--secondary" onclick="editResponse('nomura-query')">編集</button>
                    <button class="btn btn--secondary" onclick="requestApproval('nomura-query')">承認依頼</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 解決済み -->
    <div class="dialogue-section" id="resolved-section" style="display: none;">
        <div class="section-header">
            <h2>✅ 解決済み</h2>
            <p>完了した問い合わせ履歴</p>
        </div>

        <div class="resolved-list">
            <div class="resolved-item">
                <div class="item-header">
                    <div class="investor-info">
                        <span class="investor-type institutional">機関投資家</span>
                        <span class="investor-name">Mitsubishi UFJ Trust</span>
                    </div>
                    <div class="item-meta">
                        <span class="status resolved">解決済み</span>
                        <span class="resolved-time">2時間前</span>
                    </div>
                </div>
                <div class="item-content">
                    <h4>株主還元政策について</h4>
                    <p>当社の株主還元政策について質問がありました...</p>
                </div>
                <div class="resolution-summary">
                    <div class="satisfaction-score">
                        <span class="score-label">満足度:</span>
                        <span class="score-value high">5/5</span>
                    </div>
                    <div class="response-time">
                        <span class="time-label">応答時間:</span>
                        <span class="time-value">1.5時間</span>
                    </div>
                </div>
                <div class="item-actions">
                    <button class="btn btn--secondary" onclick="viewDetails('mitsubishi-query')">詳細</button>
                    <button class="btn btn--secondary" onclick="createFAQ('mitsubishi-query')">FAQ作成</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 分析 -->
    <div class="dialogue-section" id="analytics-section" style="display: none;">
        <div class="section-header">
            <h2>📊 対話分析</h2>
            <p>問い合わせの傾向と改善点</p>
        </div>

        <div class="dialogue-analytics">
            <div class="analytics-grid">
                <div class="analytics-card">
                    <h4>📈 問い合わせ推移</h4>
                    <div class="chart-placeholder">
                        <div class="chart-info">
                            <div class="chart-value">+15.3%</div>
                            <div class="chart-label">前月比</div>
                        </div>
                    </div>
                </div>
                <div class="analytics-card">
                    <h4>⏱️ 平均応答時間</h4>
                    <div class="analytics-value">2.3時間</div>
                    <div class="analytics-change positive">-0.5時間</div>
                </div>
                <div class="analytics-card">
                    <h4>🎯 満足度</h4>
                    <div class="analytics-value">96.8%</div>
                    <div class="analytics-change positive">+2.1%</div>
                </div>
                <div class="analytics-card">
                    <h4>🔄 解決率</h4>
                    <div class="analytics-value">98.5%</div>
                    <div class="analytics-change positive">+1.2%</div>
                </div>
            </div>

            <div class="trend-analysis">
                <h3>📊 傾向分析</h3>
                <div class="trend-items">
                    <div class="trend-item">
                        <span class="trend-icon">📈</span>
                        <div class="trend-content">
                            <h4>ESG関連質問増加</h4>
                            <p>ESG戦略に関する質問が前月比45%増加しています。</p>
                        </div>
                    </div>
                    <div class="trend-item">
                        <span class="trend-icon">⚠️</span>
                        <div class="trend-content">
                            <h4>技術詳細質問の複雑化</h4>
                            <p>技術的な質問の平均文字数が20%増加しています。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// セクション切り替え
document.querySelectorAll('.section-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const sectionId = this.dataset.section;
        
        // アクティブ状態を更新
        document.querySelectorAll('.section-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // セクション表示を切り替え
        document.querySelectorAll('.dialogue-section').forEach(section => {
            section.style.display = 'none';
        });
        document.getElementById(sectionId + '-section').style.display = 'block';
    });
});

// フィルター機能
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        const filter = this.dataset.filter;
        filterInboxItems(filter);
    });
});

function filterInboxItems(filter) {
    const items = document.querySelectorAll('.inbox-item');
    items.forEach(item => {
        if (filter === 'all' || item.classList.contains(filter)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

// 対話機能
async function openDialogue(queryId) {
    try {
        const response = await fetch(`/api/dialogue/open/${queryId}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            // 対話画面を開く
            showDialogueModal(queryId);
        }
    } catch (error) {
        KAGAMI.notify.toast('対話の開始に失敗しました', 'error');
    }
}

function showDialogueModal(queryId) {
    // モーダル表示ロジック
    KAGAMI.notify.toast('対話画面を開きました', 'info');
}

async function assignTo(queryId) {
    try {
        const response = await fetch(`/api/dialogue/assign/${queryId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ assignee: 'current_user' })
        });
        const result = await response.json();
        
        if (result.success) {
            KAGAMI.notify.toast('担当者を割り当てました', 'success');
        }
    } catch (error) {
        KAGAMI.notify.toast('担当者割り当てに失敗しました', 'error');
    }
}

async function createFAQ(queryId) {
    try {
        const response = await fetch(`/api/dialogue/create-faq/${queryId}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            KAGAMI.notify.toast('FAQ作成を開始しました', 'success');
            // FAQ管理ページにリダイレクト
            window.location.href = '/ai-faq';
        }
    } catch (error) {
        KAGAMI.notify.toast('FAQ作成に失敗しました', 'error');
    }
}

async function sendResponse(queryId) {
    try {
        const response = await fetch(`/api/dialogue/send/${queryId}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            KAGAMI.notify.toast('回答を送信しました', 'success');
            updateActiveList();
        }
    } catch (error) {
        KAGAMI.notify.toast('回答送信に失敗しました', 'error');
    }
}

async function editResponse(queryId) {
    KAGAMI.notify.toast('編集機能は開発中です', 'info');
}

async function requestApproval(queryId) {
    try {
        const response = await fetch(`/api/dialogue/approval/${queryId}`, {
            method: 'POST'
        });
        const result = await response.json();
        
        if (result.success) {
            KAGAMI.notify.toast('承認依頼を送信しました', 'success');
        }
    } catch (error) {
        KAGAMI.notify.toast('承認依頼に失敗しました', 'error');
    }
}

async function viewDetails(queryId) {
    try {
        const response = await fetch(`/api/dialogue/details/${queryId}`);
        const details = await response.json();
        
        // 詳細モーダルを開く
        showDetailsModal(details);
    } catch (error) {
        KAGAMI.notify.toast('詳細の取得に失敗しました', 'error');
    }
}

function showDetailsModal(details) {
    // 詳細モーダル表示ロジック
    console.log('詳細:', details);
}

async function updateActiveList() {
    try {
        const response = await fetch('/api/dialogue/active');
        const activeItems = await response.json();
        
        // 進行中リストを更新
        console.log('進行中更新:', activeItems);
    } catch (error) {
        console.error('進行中リスト更新エラー:', error);
    }
}

// ソート機能
document.getElementById('sortSelect').addEventListener('change', function() {
    const sortBy = this.value;
    sortInboxItems(sortBy);
});

function sortInboxItems(sortBy) {
    const items = Array.from(document.querySelectorAll('.inbox-item'));
    
    items.sort((a, b) => {
        switch(sortBy) {
            case 'time':
                return new Date(b.querySelector('.received-time').textContent) - 
                       new Date(a.querySelector('.received-time').textContent);
            case 'priority':
                const priorityOrder = { 'urgent': 3, 'high': 2, 'normal': 1 };
                const aPriority = a.querySelector('.priority').classList.contains('urgent') ? 'urgent' : 'normal';
                const bPriority = b.querySelector('.priority').classList.contains('urgent') ? 'urgent' : 'normal';
                return priorityOrder[bPriority] - priorityOrder[aPriority];
            case 'investor':
                const aType = a.querySelector('.investor-type').textContent;
                const bType = b.querySelector('.investor-type').textContent;
                return aType.localeCompare(bType);
            default:
                return 0;
        }
    });
    
    const container = document.querySelector('.inbox-list');
    items.forEach(item => container.appendChild(item));
}

// リアルタイム更新
setInterval(updateActiveList, 30000); // 30秒間隔
</script>
{% endblock %} 